rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Bookings collection
    match /bookings/{bookingId} {
      // Allow read for everyone (needed for availability check and admin panel)
      allow read: if true;

      // Allow create for everyone (public booking form + iCal sync)
      allow create: if
        // Required fields for all bookings
        request.resource.data.keys().hasAll([
          'checkIn', 'checkOut', 'status', 'createdAt'
        ]) &&
        (
          // Public booking form (from website)
          (
            request.resource.data.keys().hasAll([
              'guests', 'firstName', 'lastName', 'email', 'phone',
              'nights', 'totalPrice', 'pricePerNight'
            ]) &&
            request.resource.data.status == 'pending'
          ) ||
          // iCal sync (from Booking.com or other platforms)
          (
            request.resource.data.keys().hasAll([
              'source', 'externalId', 'syncedAt'
            ]) &&
            request.resource.data.status == 'confirmed' &&
            request.resource.data.source in ['booking.com', 'beds24', 'airbnb']
          )
        );

      // Allow update/delete for everyone (TODO: add auth for admin only)
      allow update, delete: if true;
    }

    // Sync logs collection
    match /syncLogs/{logId} {
      // Allow read for everyone (needed for admin panel)
      allow read: if true;

      // Allow create for everyone (needed for API endpoints)
      allow create: if
        request.resource.data.keys().hasAll([
          'timestamp', 'type', 'status', 'message'
        ]) &&
        request.resource.data.type in ['sync', 'import', 'export'] &&
        request.resource.data.status in ['success', 'error'];

      // No updates or deletes allowed
      allow update, delete: if false;
    }
  }
}

